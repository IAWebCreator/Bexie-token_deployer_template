<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Token Deployer</title>
  <!-- Load ethers from unpkg CDN - more reliable than cdnjs for ethers -->
  <script src="https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js"
          type="application/javascript"></script>
  <script src="config.js"></script>
  <style>
    .form-container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }

    body {
      background-color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    .form-section {
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e1e1;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    .web-option {
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 10px 0;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>Token Deployer</h1>

    <div id="walletInfo" style="display: none; margin: 20px 0;">
      <p>Connected Account: <code id="accountDisplay">Not connected</code></p>
      <p>Network: <code id="networkDisplay">Not connected</code></p>
    </div>

    <button id="connectButton">Connect Metamask</button>

    <hr>

    <h2>Create a New Token</h2>
    
    <div class="form-section">
      <h3>Basic Information</h3>
      <div class="form-group">
        <label>Token Name *</label>
        <input type="text" id="tokenName" class="form-control" placeholder="e.g. MyToken" required />
      </div>
      <div class="form-group">
        <label>Token Symbol *</label>
        <input type="text" id="tokenSymbol" class="form-control" placeholder="e.g. MYT" maxlength="5" required/>
      </div>
    </div>

    <div class="form-section">
      <h3>Token Details</h3>
      <div class="form-group">
        <label>Token Description *</label>
        <textarea id="tokenDescription" class="form-control" placeholder="Describe your token's purpose and features" required></textarea>
      </div>
      <div class="form-group">
        <label>Logo Upload *</label>
        <input type="file" id="logoUpload" class="form-control" accept="image/*" required />
      </div>
    </div>

    <div class="form-section">
      <h3>Social Media & Website</h3>
      <div class="form-group">
        <label>X (Twitter) Link</label>
        <input type="url" id="twitterLink" class="form-control" placeholder="https://twitter.com/youraccount" />
      </div>
      <div class="form-group">
        <label>Telegram Link</label>
        <input type="url" id="telegramLink" class="form-control" placeholder="https://t.me/youraccount" />
      </div>
      <div class="form-group">
        <label>Website Option *</label>
        <div class="web-option">
          <input type="radio" id="existingWebsite" name="websiteOption" value="existing" checked />
          <label for="existingWebsite">Existing Website Link</label>
        </div>
        <input type="url" id="websiteLink" class="form-control" placeholder="https://yourwebsite.com" />
        <div class="web-option">
          <input type="radio" id="createWebsite" name="websiteOption" value="create" />
          <label for="createWebsite">Create a webpage using Bexie AI Agent</label>
        </div>
      </div>
    </div>
    
    <p>Note: The factory requires a creationFee of <code>0.002 BERA</code>.</p>
    <button id="createTokenBtn">Create Token</button>
  </div>

  <script>
    // Wrap all JavaScript in a function that runs after ethers is loaded
    function initApp() {
      let provider;
      let signer;
      
      // Network configuration from config
      const SUPPORTED_CHAIN_ID = CONFIG.CHAIN_ID;
      const NETWORK_CONFIG = {
          chainId: CONFIG.CHAIN_ID,
          chainName: CONFIG.NETWORK_NAME,
          nativeCurrency: {
              name: 'BERA',
              symbol: 'BERA',
              decimals: 18
          },
          rpcUrls: [CONFIG.RPC_URL],
          blockExplorerUrls: [CONFIG.EXPLORER_URL]
      };

      // Initialize only after both DOM and ethers are ready
      if (typeof window.ethereum !== 'undefined' && typeof ethers !== 'undefined') {
          console.log('MetaMask and ethers are installed!');
          initializeWalletHandlers();
      } else {
          console.log('MetaMask or ethers is not installed');
          document.getElementById('connectButton').addEventListener('click', () => {
              alert("Please install MetaMask!");
              window.open('https://metamask.io', '_blank');
          });
      }

      // Initialize wallet connection handlers
      async function initializeWalletHandlers() {
          // Handle account changes
          window.ethereum.on('accountsChanged', (accounts) => {
              if (accounts.length === 0) {
                  disconnectWallet();
              } else {
                  updateWalletInfo(accounts[0]);
              }
          });

          // Handle chain changes
          window.ethereum.on('chainChanged', (chainId) => {
              window.location.reload();
          });

          // Check if already connected
          try {
              const accounts = await window.ethereum.request({ method: 'eth_accounts' });
              if (accounts.length > 0) {
                  provider = new ethers.BrowserProvider(window.ethereum);
                  signer = await provider.getSigner();
                  updateWalletInfo(accounts[0]);
              }
          } catch (err) {
              console.error('Error checking initial accounts:', err);
          }
      }

      // Update wallet info in UI
      function updateWalletInfo(account) {
          const walletInfo = document.getElementById('walletInfo');
          const accountDisplay = document.getElementById('accountDisplay');
          const networkDisplay = document.getElementById('networkDisplay');
          const connectButton = document.getElementById('connectButton');

          if (account) {
              walletInfo.style.display = 'block';
              accountDisplay.textContent = `${account.slice(0,6)}...${account.slice(-4)}`;
              networkDisplay.textContent = 'Berachain bArtio';
              connectButton.textContent = 'Wallet Connected';
              connectButton.disabled = true;
          } else {
              walletInfo.style.display = 'none';
              connectButton.textContent = 'Connect Metamask';
              connectButton.disabled = false;
              // Reset provider and signer when disconnecting
              provider = null;
              signer = null;
          }
      }

      // Disconnect wallet function
      function disconnectWallet() {
          provider = null;
          signer = null;
          updateWalletInfo(null);
      }

      // Check and switch network if needed
      async function ensureCorrectNetwork() {
          if (!window.ethereum) return false;
          
          try {
              await window.ethereum.request({
                  method: 'wallet_switchEthereumChain',
                  params: [{ chainId: SUPPORTED_CHAIN_ID }],
              });
              return true;
          } catch (switchError) {
              // This error code indicates that the chain has not been added to MetaMask.
              if (switchError.code === 4902) {
                  try {
                      await window.ethereum.request({
                          method: 'wallet_addEthereumChain',
                          params: [NETWORK_CONFIG],
                      });
                      return true;
                  } catch (addError) {
                      console.error('Failed to add network:', addError);
                      return false;
                  }
              }
              console.error('Failed to switch network:', switchError);
              return false;
          }
      }

      // Modified connect function
      document.getElementById("connectButton").onclick = async function() {
          // Double-check MetaMask is available
          if (typeof window.ethereum === 'undefined') {
              alert("Please install MetaMask!");
              window.open('https://metamask.io', '_blank');
              return;
          }

          try {
              // Request accounts first
              const accounts = await window.ethereum.request({ 
                  method: 'eth_requestAccounts',
                  params: [] 
              });

              // Then ensure correct network
              const networkSwitched = await ensureCorrectNetwork();
              if (!networkSwitched) {
                  alert("Please switch to Berachain bArtio network in MetaMask");
                  return;
              }
              
              // Set up provider and signer
              provider = new ethers.BrowserProvider(window.ethereum);
              signer = await provider.getSigner();
              
              // Update UI
              updateWalletInfo(accounts[0]);
          } catch (err) {
              console.error(err);
              if (err.code === 4001) {
                  alert("Please connect to MetaMask.");
              } else {
                  alert("Failed to connect: " + (err.message || err));
              }
          }
      };

      document.getElementById("createTokenBtn").onclick = async function() {
        if (!signer) {
          console.warn('‚ö†Ô∏è Wallet not connected - please connect Metamask first');
          alert("Please connect Metamask first!");
          return;
        }

        // Collect form data
        const name = document.getElementById("tokenName").value.trim();
        const symbol = document.getElementById("tokenSymbol").value.trim();

        if (!name || !symbol) {
          console.warn('‚ö†Ô∏è Missing required fields');
          alert("Fill all fields (name and symbol)!");
          return;
        }

        try {
          console.info('üöÄ STARTING TOKEN DEPLOYMENT');
          console.info('='.repeat(50));
          console.info(`Token Name: ${name}`);
          console.info(`Token Symbol: ${symbol}`);
          console.info(`Factory Address: ${CONFIG.TOKEN_FACTORY_ADDRESS}`);
          console.info(`Initial Supply: ${CONFIG.INITIAL_SUPPLY}`);
          console.info('='.repeat(50));
          
          // Full ABI for the factory's createToken function and event
          const factoryAbi = [
            "function createToken(string memory name, string memory symbol, uint256 initialSupply, address priceFeedAddress) external payable",
            "event TokenCreated(address indexed creator, address tokenAddress, address bondingCurveAddress, string name, string symbol)"
          ];
          const factoryContract = new ethers.Contract(CONFIG.TOKEN_FACTORY_ADDRESS, factoryAbi, signer);

          // The creationFee from config
          const creationFee = ethers.parseEther(CONFIG.CREATION_FEE);
          console.info(`üí∞ Creation fee: ${CONFIG.CREATION_FEE} BERA`);

          // Call createToken with configured values
          console.info('üìù Sending transaction to create token...');
          const tx = await factoryContract.createToken(
            name,
            symbol,
            CONFIG.INITIAL_SUPPLY,
            CONFIG.PRICE_FEED_ADDRESS,
            { value: creationFee }
          );
          console.info(`üì® Transaction sent! Hash: ${tx.hash}`);
          alert("Transaction sent! Hash: " + tx.hash);

          console.info('‚è≥ Waiting for transaction confirmation...');
          const receipt = await tx.wait();
          console.info(`‚úÖ Transaction confirmed in block ${receipt.blockNumber}`);
          
          // Parse the TokenCreated event
          const event = receipt.logs
            .map(log => {
              try {
                return factoryContract.interface.parseLog({
                  topics: log.topics,
                  data: log.data
                });
              } catch (e) {
                return null;
              }
            })
            .find(event => event && event.name === 'TokenCreated');

          if (event) {
            const successMessage = 
              "Token created successfully!\n\n" +
              `Token Address: ${event.args.tokenAddress}\n` +
              `Bonding Curve Address: ${event.args.bondingCurveAddress}\n\n` +
              `Confirmed in block ${receipt.blockNumber}`;
            
            console.info('\n' + '='.repeat(50));
            console.info('üéâ TOKEN DEPLOYMENT SUCCESS');
            console.info('='.repeat(50));
            console.info(successMessage);
            console.info('='.repeat(50));
            alert(successMessage);
          } else {
            console.warn('‚ö†Ô∏è Token created but event not found');
            console.info(`‚úÖ Confirmed in block ${receipt.blockNumber}`);
            alert("Token created! Confirmed in block " + receipt.blockNumber);
          }

        } catch(err) {
          console.error('‚ùå TOKEN DEPLOYMENT FAILED');
          console.error('='.repeat(50));
          console.error(err);
          console.error('='.repeat(50));
          alert("Error: " + (err.message || err));
        }
      };
    }

    // Check if ethers is loaded
    function waitForEthers() {
      if (typeof ethers !== 'undefined') {
        // ethers is loaded, initialize the app
        initApp();
      } else {
        // ethers not loaded yet, wait and try again
        setTimeout(waitForEthers, 100);
      }
    }

    // Start checking once the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      waitForEthers();
    });
  </script>
</body>
</html>