<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Token Deployer</title>
  <!-- Load ethers from unpkg CDN - more reliable than cdnjs for ethers -->
  <script src="https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js"
          type="application/javascript"></script>
</head>
<body style="font-family: sans-serif; margin: 20px;">
  <h1>Token Deployer</h1>

  <div id="walletInfo" style="display: none; margin: 20px 0;">
    <p>Connected Account: <code id="accountDisplay">Not connected</code></p>
    <p>Network: <code id="networkDisplay">Not connected</code></p>
  </div>

  <button id="connectButton">Connect Metamask</button>

  <div style="margin-top: 20px;">
    <label>Token Factory Address:</label><br>
    <input type="text" id="factoryAddress" size="60" placeholder="Paste the factory contract address here" />
  </div>

  <hr>

  <h2>Create a New Token</h2>
  <p>Enter token details below:</p>
  
  <div>
    <label>Token Name</label><br>
    <input type="text" id="tokenName" placeholder="e.g. MyToken" />
  </div>
  <div>
    <label>Token Symbol</label><br>
    <input type="text" id="tokenSymbol" placeholder="e.g. MYT" maxlength="5"/>
  </div>
  <div>
    <label>Initial Supply</label><br>
    <input type="number" id="initialSupply" placeholder="e.g. 1000000" />
  </div>
  <div>
    <label>Price Feed Address (Chainlink style aggregator):</label><br>
    <input type="text" id="priceFeed" placeholder="e.g. 0x..." size="60" />
  </div>
  
  <p>Note: The factory requires a creationFee of <code>0.002 BERA</code>.</p>
  <button id="createTokenBtn">Create Token</button>

  <script>
    // Wrap all JavaScript in a function that runs after ethers is loaded
    function initApp() {
      let provider;
      let signer;
      
      // Network configuration
      const SUPPORTED_CHAIN_ID = '0x138D4'; // Berachain bArtio (hex for 80084)
      const NETWORK_CONFIG = {
          chainId: SUPPORTED_CHAIN_ID,
          chainName: 'Berachain bArtio',
          nativeCurrency: {
              name: 'BERA',
              symbol: 'BERA',
              decimals: 18
          },
          rpcUrls: ['https://bartio.rpc.berachain.com/'],
          blockExplorerUrls: ['https://bartio.beratrail.io/']
      };

      // Initialize only after both DOM and ethers are ready
      if (typeof window.ethereum !== 'undefined' && typeof ethers !== 'undefined') {
          console.log('MetaMask and ethers are installed!');
          initializeWalletHandlers();
      } else {
          console.log('MetaMask or ethers is not installed');
          document.getElementById('connectButton').addEventListener('click', () => {
              alert("Please install MetaMask!");
              window.open('https://metamask.io', '_blank');
          });
      }

      // Initialize wallet connection handlers
      async function initializeWalletHandlers() {
          // Handle account changes
          window.ethereum.on('accountsChanged', (accounts) => {
              if (accounts.length === 0) {
                  disconnectWallet();
              } else {
                  updateWalletInfo(accounts[0]);
              }
          });

          // Handle chain changes
          window.ethereum.on('chainChanged', (chainId) => {
              window.location.reload();
          });

          // Check if already connected
          try {
              const accounts = await window.ethereum.request({ method: 'eth_accounts' });
              if (accounts.length > 0) {
                  provider = new ethers.BrowserProvider(window.ethereum);
                  signer = await provider.getSigner();
                  updateWalletInfo(accounts[0]);
              }
          } catch (err) {
              console.error('Error checking initial accounts:', err);
          }
      }

      // Update wallet info in UI
      function updateWalletInfo(account) {
          const walletInfo = document.getElementById('walletInfo');
          const accountDisplay = document.getElementById('accountDisplay');
          const networkDisplay = document.getElementById('networkDisplay');
          const connectButton = document.getElementById('connectButton');

          if (account) {
              walletInfo.style.display = 'block';
              accountDisplay.textContent = `${account.slice(0,6)}...${account.slice(-4)}`;
              networkDisplay.textContent = 'Berachain bArtio';
              connectButton.textContent = 'Wallet Connected';
              connectButton.disabled = true;
          } else {
              walletInfo.style.display = 'none';
              connectButton.textContent = 'Connect Metamask';
              connectButton.disabled = false;
              // Reset provider and signer when disconnecting
              provider = null;
              signer = null;
          }
      }

      // Disconnect wallet function
      function disconnectWallet() {
          provider = null;
          signer = null;
          updateWalletInfo(null);
      }

      // Check and switch network if needed
      async function ensureCorrectNetwork() {
          if (!window.ethereum) return false;
          
          try {
              await window.ethereum.request({
                  method: 'wallet_switchEthereumChain',
                  params: [{ chainId: SUPPORTED_CHAIN_ID }],
              });
              return true;
          } catch (switchError) {
              // This error code indicates that the chain has not been added to MetaMask.
              if (switchError.code === 4902) {
                  try {
                      await window.ethereum.request({
                          method: 'wallet_addEthereumChain',
                          params: [NETWORK_CONFIG],
                      });
                      return true;
                  } catch (addError) {
                      console.error('Failed to add network:', addError);
                      return false;
                  }
              }
              console.error('Failed to switch network:', switchError);
              return false;
          }
      }

      // Modified connect function
      document.getElementById("connectButton").onclick = async function() {
          // Double-check MetaMask is available
          if (typeof window.ethereum === 'undefined') {
              alert("Please install MetaMask!");
              window.open('https://metamask.io', '_blank');
              return;
          }

          try {
              // Request accounts first
              const accounts = await window.ethereum.request({ 
                  method: 'eth_requestAccounts',
                  params: [] 
              });

              // Then ensure correct network
              const networkSwitched = await ensureCorrectNetwork();
              if (!networkSwitched) {
                  alert("Please switch to Berachain bArtio network in MetaMask");
                  return;
              }
              
              // Set up provider and signer
              provider = new ethers.BrowserProvider(window.ethereum);
              signer = await provider.getSigner();
              
              // Update UI
              updateWalletInfo(accounts[0]);
          } catch (err) {
              console.error(err);
              if (err.code === 4001) {
                  alert("Please connect to MetaMask.");
              } else {
                  alert("Failed to connect: " + (err.message || err));
              }
          }
      };

      document.getElementById("createTokenBtn").onclick = async function() {
        if (!signer) {
          alert("Please connect Metamask first!");
          return;
        }
        const factoryAddr = document.getElementById("factoryAddress").value.trim();
        if (!factoryAddr) {
          alert("Please enter the TokenFactory contract address");
          return;
        }

        // Collect form data
        const name = document.getElementById("tokenName").value.trim();
        const symbol = document.getElementById("tokenSymbol").value.trim();
        const initialSupply = document.getElementById("initialSupply").value.trim();
        const priceFeed = document.getElementById("priceFeed").value.trim();

        if (!name || !symbol || !initialSupply || !priceFeed) {
          alert("Fill all fields (name, symbol, supply, price feed)!");
          return;
        }

        try {
          // Full ABI for the factory's createToken function and event
          const factoryAbi = [
            "function createToken(string memory name, string memory symbol, uint256 initialSupply, address priceFeedAddress) external payable",
            "event TokenCreated(address indexed creator, address tokenAddress, address bondingCurveAddress, string name, string symbol)"
          ];
          const factoryContract = new ethers.Contract(factoryAddr, factoryAbi, signer);

          // The creationFee = 0.002 BERA => 0.002 * 1e18 = 2000000000000000 wei
          const creationFee = ethers.parseEther("0.002");

          // Call createToken
          const tx = await factoryContract.createToken(
            name,
            symbol,
            initialSupply,   // for example, 1000000
            priceFeed,
            { value: creationFee }
          );
          alert("Transaction sent! Hash: " + tx.hash);

          const receipt = await tx.wait();
          
          // Parse the TokenCreated event
          const event = receipt.logs
            .map(log => {
              try {
                return factoryContract.interface.parseLog({
                  topics: log.topics,
                  data: log.data
                });
              } catch (e) {
                return null;
              }
            })
            .find(event => event && event.name === 'TokenCreated');

          if (event) {
            alert(
              "Token created successfully!\n\n" +
              `Token Address: ${event.args.tokenAddress}\n` +
              `Bonding Curve Address: ${event.args.bondingCurveAddress}\n\n` +
              `Confirmed in block ${receipt.blockNumber}`
            );
          } else {
            alert("Token created! Confirmed in block " + receipt.blockNumber);
          }

        } catch(err) {
          console.error(err);
          alert("Error: " + (err.message || err));
        }
      };
    }

    // Check if ethers is loaded
    function waitForEthers() {
      if (typeof ethers !== 'undefined') {
        // ethers is loaded, initialize the app
        initApp();
      } else {
        // ethers not loaded yet, wait and try again
        setTimeout(waitForEthers, 100);
      }
    }

    // Start checking once the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      waitForEthers();
    });
  </script>
</body>
</html>